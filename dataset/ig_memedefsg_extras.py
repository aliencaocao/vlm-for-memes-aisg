from pathlib import Path
from asyncio import run

import pandas as pd
from tqdm.contrib.concurrent import process_map

from gpt import get_responses, DatasetImage
from image_utils import process_single_image

root = Path('ig_memedefsg')
img_root = root
todo_images = ['2018-09-30_04-02-09_UTC',
 '2019-09-30_13-17-41_UTC',
 '2020-05-04_03-25-53_UTC',
 '2020-05-07_03-31-40_UTC',
 '2021-05-06_13-15-37_UTC',
 '2021-05-18_10-12-38_UTC',
 '2021-05-22_05-23-35_UTC',
 '2021-07-19_10-14-16_UTC',
 '2021-08-15_06-54-19_UTC',
 '2021-08-17_07-53-29_UTC',
 '2021-08-21_09-48-39_UTC_2',
 '2021-08-26_06-37-03_UTC',
 '2021-08-27_07-34-47_UTC',
 '2021-08-27_10-05-20_UTC',
 '2021-08-30_06-44-32_UTC',
 '2021-08-31_02-29-12_UTC',
 '2021-08-31_07-42-10_UTC',
 '2021-09-03_05-09-44_UTC',
 '2021-09-07_06-01-31_UTC',
 '2021-09-13_09-51-05_UTC',
 '2021-09-21_10-00-52_UTC_1',
 '2021-09-24_10-35-06_UTC',
 '2021-09-24_11-26-15_UTC',
 '2021-09-30_09-56-11_UTC_2',
 '2021-10-02_14-38-28_UTC_2',
 '2021-10-04_06-33-01_UTC',
 '2021-10-09_04-27-07_UTC',
 '2021-10-10_08-01-05_UTC',
 '2021-10-13_02-21-30_UTC',
 '2021-10-14_02-24-14_UTC',
 '2021-10-15_08-45-24_UTC',
 '2021-10-18_10-43-43_UTC',
 '2021-10-19_04-03-48_UTC_1',
 '2021-10-19_04-03-48_UTC_2',
 '2021-10-19_04-03-48_UTC_5',
 '2021-10-20_12-53-58_UTC',
 '2021-10-28_04-23-29_UTC',
 '2021-11-03_08-14-55_UTC',
 '2021-11-09_03-55-02_UTC',
 '2021-11-10_10-27-14_UTC',
 '2021-11-20_11-12-48_UTC',
 '2021-11-24_05-15-01_UTC',
 '2021-12-13_12-03-13_UTC_1',
 '2021-12-13_12-03-13_UTC_2',
 '2021-12-13_12-03-13_UTC_3',
 '2021-12-14_04-00-09_UTC_1',
 '2021-12-14_04-00-09_UTC_2',
 '2021-12-16_05-50-31_UTC',
 '2021-12-21_12-44-51_UTC',
 '2021-12-22_07-51-35_UTC',
 '2021-12-25_03-10-07_UTC',
 '2021-12-26_05-17-31_UTC',
 '2021-12-29_07-29-10_UTC',
 '2022-01-01_10-08-24_UTC',
 '2022-01-21_09-24-36_UTC',
 '2022-01-27_14-01-09_UTC',
 '2022-02-01_04-00-02_UTC',
 '2022-02-07_14-24-50_UTC',
 '2022-02-11_06-12-45_UTC',
 '2022-02-14_04-01-59_UTC_1',
 '2022-02-14_04-01-59_UTC_2',
 '2022-03-01_01-23-01_UTC',
 '2022-03-03_02-29-31_UTC',
 '2022-03-04_05-46-51_UTC',
 '2022-03-21_02-01-49_UTC',
 '2022-03-24_03-44-02_UTC',
 '2022-03-24_05-23-53_UTC',
 '2022-03-29_08-29-59_UTC_1',
 '2022-03-29_08-29-59_UTC_2',
 '2022-04-19_10-20-51_UTC',
 '2022-04-22_10-01-21_UTC',
 '2022-05-09_02-58-45_UTC',
 '2022-05-15_14-58-10_UTC',
 '2022-06-28_16-44-01_UTC_profile_pic',
 '2022-07-09_12-27-07_UTC',
 '2022-07-16_08-51-22_UTC',
 '2022-08-13_14-24-43_UTC',
 '2022-09-23_08-41-09_UTC',
 '2022-10-02_14-33-48_UTC',
 '2022-11-13_03-56-14_UTC',
 '2023-01-19_04-41-10_UTC',
 '2023-01-22_15-00-12_UTC',
 '2023-01-23_03-32-36_UTC',
 '2023-01-27_07-42-18_UTC',
 '2023-01-29_03-40-52_UTC',
 '2023-02-01_09-04-43_UTC',
 '2023-02-05_10-22-09_UTC',
 '2023-02-11_04-12-43_UTC',
 '2023-02-13_05-25-59_UTC',
 '2023-03-06_07-58-37_UTC_1',
 '2023-03-06_07-58-37_UTC_2',
 '2023-03-06_07-58-37_UTC_3',
 '2023-03-06_07-58-37_UTC_4',
 '2023-07-17_07-56-07_UTC',
 '2023-07-18_06-31-37_UTC',
 '2023-08-22_07-21-06_UTC',
 '2023-12-10_10-02-00_UTC',
 '2024-02-11_12-51-06_UTC_1',
 '2024-02-11_12-51-06_UTC_2',
 '2024-02-11_12-51-06_UTC_3',
 '2024-02-16_12-47-45_UTC']


def process_image():
    """Only needs to be ran once, not needed for getting gpt labels"""
    all_images = list(img_root.rglob('*.*'))
    processed = process_map(process_single_image, all_images, chunksize=1)
    processed = pd.DataFrame.from_records(processed, columns=['image_id', 'img'])
    processed.dropna(inplace=True)  # drop error ones
    processed = processed.set_index('image_id')
    processed.to_csv(root / 'metadata.csv', index=True)


if __name__ == '__main__':
    processed = pd.read_csv(root / 'metadata.csv')
    processed['image_id'] = processed['image_id'].astype(str)
    processed = [DatasetImage(
        id=x['image_id'],
        path=x['img'],
        lang='en', # assume reddit is English
    ) for _, x in processed.iterrows() if x['image_id'] in todo_images]
    run(get_responses(str(root), processed, output_path=root / 'labels2.csv'))

